<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courier Logistics Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        .card {
            height: 100%;
        }
        .btn-group-toggle .btn {
            margin-right: 5px;
        }
        .bold-heading {
            font-weight: bold;
        }
        #map {
            width: 100%;
            height: 400px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <h1 class="text-center bold-heading">Courier Logistics Dashboard</h1>
        
        <div class="row mt-4">
            <!-- Flight Tracking Section -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h2 class="bold-heading">Flight Tracking</h2>
                    </div>
                    <div class="card-body">
                        <form id="flightForm" method="post" action="/get_flight_info">
                            <div class="form-row">
                                <div class="col">
                                    <input type="text" class="form-control" id="airlineCode" name="airline_code" placeholder="Airline Code (e.g., SWA)" value="SWA" required>
                                </div>
                                <div class="col">
                                    <input type="text" class="form-control" id="flightNumber" name="flight_number" placeholder="Flight Number" value="3719" required>
                                </div>
                            </div>
                            <div class="form-group mt-2">
                                <label class="bold-heading">Update Frequency:</label>
                                <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
                                    <label class="btn btn-danger">
                                        <input type="radio" name="updateFrequency" value="60000"> 60s
                                    </label>
                                    <label class="btn btn-warning">
                                        <input type="radio" name="updateFrequency" value="300000"> 5m
                                    </label>
                                    <label class="btn btn-info">
                                        <input type="radio" name="updateFrequency" value="900000"> 15m
                                    </label>
                                    <label class="btn btn-primary active">
                                        <input type="radio" name="updateFrequency" value="1800000" checked> 30m
                                    </label>
                                    <label class="btn btn-secondary">
                                        <input type="radio" name="updateFrequency" value="3600000"> 60m
                                    </label>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">Track Flight</button>
                            <button id="stopUpdates" class="btn btn-danger" style="display: none;">Stop Updates</button>
                        </form>
                        <div id="flightInfo" class="mt-3"></div>
                        <div id="flightDelayInfo" class="mt-2 text-danger small"></div>
                        <div id="lastUpdated" class="mt-2 text-muted small"></div>
                        <div id="nextUpdate" class="mt-2 text-muted small"></div>
                    </div>
                </div>
            </div>

            <!-- Cargo Waybill Section -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h2 class="bold-heading">Cargo Waybill</h2>
                    </div>
                    <div class="card-body">
                        <form id="waybillForm">
                            <div class="form-group">
                                <input type="text" class="form-control" id="waybillNumber" placeholder="Enter Waybill Number" value="14559565" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Track Cargo</button>
                        </form>
                        <div id="waybillInfo" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Navigation Section -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h2 class="bold-heading">Navigation</h2>
                    </div>
                    <div class="card-body">
                        <form id="navigationForm">
                            <div class="form-group">
                                <input type="text" class="form-control" id="destination" value="8835 Bear Rd, Orlando, FL" required>
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" id="finalDestination" placeholder="Enter Final Destination" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Get Directions</button>
                        </form>
                        <div id="map"></div>
                        <div id="navigationInfo" class="mt-3"></div>
                        <div id="etaInfo" class="mt-3 text-muted small"></div>
                    </div>
                </div>
            </div>

            <!-- Weather and Traffic Section -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h2 class="bold-heading">Weather & Traffic</h2>
                    </div>
                    <div class="card-body">
                        <div id="weatherInfo"></div>
                        <div id="trafficInfo" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.0/mapbox-gl-directions.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.0/mapbox-gl-directions.css' type='text/css' />
    <script>
        $(document).ready(function(){
            let refreshInterval;
            let lastSubmittedData;
            let updateFrequency;
            mapboxgl.accessToken = '{{ mapbox_key }}';
            var map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [-81.379234, 28.538336], // starting position [lng, lat]
                zoom: 9 // starting zoom
            });

            var directions = new MapboxDirections({
                accessToken: mapboxgl.accessToken,
                unit: 'metric',
                profile: 'mapbox/driving'
            });

            map.addControl(directions, 'top-left');

            function updateLastUpdated() {
                $('#lastUpdated').text('Last updated: ' + new Date().toLocaleTimeString());
            }

            function updateNextUpdate() {
                let nextUpdateTime = new Date(Date.now() + updateFrequency);
                $('#nextUpdate').text('Next update: ' + nextUpdateTime.toLocaleTimeString());
            }

            function fetchFlightInfo() {
                $.ajax({
                    type: 'POST',
                    url: '/get_flight_info',
                    data: lastSubmittedData,
                    success: function(data){
                        if (data.error) {
                            $('#flightInfo').html(`<p class="text-danger">${data.error}</p>`);
                        } else {
                            let infoHtml = `
                                <p><strong>ICAO24:</strong> ${data.icao24}</p>
                                <p><strong>Callsign:</strong> ${data.callsign}</p>
                                <p><strong>Origin Country:</strong> ${data.origin_country}</p>
                                <p><strong>Longitude:</strong> ${data.longitude}</p>
                                <p><strong>Latitude:</strong> ${data.latitude}</p>
                                <p><strong>Altitude:</strong> ${data.altitude} meters</p>
                                <p><strong>Velocity:</strong> ${data.velocity} m/s</p>
                                <p><strong>Heading:</strong> ${data.heading}°</p>
                                <p><strong>Vertical Rate:</strong> ${data.vertical_rate} m/s</p>
                            `;
                            $('#flightInfo').html(infoHtml);
                            // Placeholder for delay information
                            $('#flightDelayInfo').html(`<p><strong>Flight Delay:</strong> No delays reported</p>`);
                        }
                        updateLastUpdated();
                        updateNextUpdate();
                    },
                    error: function(xhr){
                        $('#flightInfo').html(`<p class="text-danger">Error: ${xhr.responseJSON.error}</p>`);
                        updateLastUpdated();
                        updateNextUpdate();
                    }
                });
            }

            $('#flightForm').on('submit', function(e){
                e.preventDefault();
                lastSubmittedData = $(this).serialize();
                updateFrequency = parseInt($('input[name="updateFrequency"]:checked').val());
                
                fetchFlightInfo();
                
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
                
                refreshInterval = setInterval(fetchFlightInfo, updateFrequency);
                
                $('#stopUpdates').show();
            });

            $('#stopUpdates').on('click', function() {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    $('#nextUpdate').text('Updates stopped');
                    $(this).hide();
                }
            });

            $('#waybillForm').on('submit', function(e){
                e.preventDefault();
                const waybill_number = $('#waybillNumber').val();
                $.post('/track_cargo', { waybill_number }, function(data) {
                    if (data.error) {
                        $('#waybillInfo').html(`<p class="text-danger">${data.error}</p>`);
                    } else {
                        $('#waybillInfo').html(`
                            <p><strong>Carrier:</strong> ${data.carrier_code}</p>
                            <p><strong>Tracking Number:</strong> ${data.tracking_number}</p>
                            <p><strong>Status:</strong> ${data.status}</p>
                            <p><strong>Origin:</strong> ${data.origin}</p>
                            <p><strong>Destination:</strong> ${data.destination}</p>
                            <p><strong>Last Update:</strong> ${data.last_update_time}</p>
                        `);
                    }
                }).fail(function(xhr) {
                    $('#waybillInfo').html(`<p class="text-danger">Error: ${xhr.responseText}</p>`);
                });
            });

            $('#navigationForm').on('submit', function(e){
                e.preventDefault();
                const destination = $('#destination').val();
                const finalDestination = $('#finalDestination').val();
                directions.setOrigin('current location'); // Use current location or specify as needed
                directions.addWaypoint(0, destination);
                directions.setDestination(finalDestination);
                // Placeholder logic for navigation and ETA
                $('#navigationInfo').html('<p>Navigation directions would appear here.</p>');
                $('#etaInfo').html('<p>ETA to final destination would appear here.</p>');
            });

            // Simulated weather and traffic info
            $('#weatherInfo').html('<p><strong>Weather:</strong> Partly cloudy, 75°F</p>');
            $('#trafficInfo').html('<p><strong>Traffic:</strong> Moderate congestion on I-4</p>');
        });
    </script>
</body>
</html>

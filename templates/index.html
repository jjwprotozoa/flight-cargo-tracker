<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (keep the existing head content) ... -->
    <style>
        .card { margin-bottom: 20px; }
        .status { font-weight: bold; }
        .status-ontime { background-color: #28a745; color: white; }
        .status-delayed { background-color: #dc3545; color: white; }
        #map, #flightMap { height: 400px; width: 100%; }
        .severe-condition { font-weight: bold; color: #dc3545; }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <h1 class="text-center mb-4">Courier Logistics Dashboard</h1>
        <div id="currentTime" class="text-center mb-3"></div>

        <div class="grid-container">
            <div class="grid-item">
                <!-- Flight Tracking Section -->
                <div class="card">
                    <div id="flightHeader" class="card-header bg-primary text-white">
                        Flight Tracking
                    </div>
                    <div class="card-body">
                        <form id="flightForm">
                            <!-- ... (keep existing form content) ... -->
                            <div class="list no-hairlines-md">
                                <ul>
                                    <li class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">Airline Code</div>
                                            <div class="item-input-wrap">
                                                <input type="text" id="airlineCode" placeholder="e.g., SWA" value="SWA">
                                            </div>
                                        </div>
                                    </li>
                                    <li class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">Flight Number</div>
                                            <div class="item-input-wrap">
                                                <input type="text" id="flightNumber" placeholder="Flight Number" value="3719">
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div class="block">
                                <p class="row">
                                    <button class="col button button-fill" id="trackFlightBtn">Track Flight</button>
                                    <button class="col button button-fill color-red" id="stopUpdatesBtn" style="display: none;">Stop Updates</button>
                                </p>
                            </div>
                            <div class="block-title">Update Frequency</div>
                            <div class="list">
                                <ul>
                                    <li>
                                        <label class="item-radio item-content">
                                            <input type="radio" name="updateFrequency" value="60000" />
                                            <i class="icon icon-radio"></i>
                                            <div class="item-inner">
                                                <div class="item-title">60s</div>
                                            </div>
                                        </label>
                                    </li>
                                    <li>
                                        <label class="item-radio item-content">
                                            <input type="radio" name="updateFrequency" value="300000" />
                                            <i class="icon icon-radio"></i>
                                            <div class="item-inner">
                                                <div class="item-title">5m</div>
                                            </div>
                                        </label>
                                    </li>
                                    <li>
                                        <label class="item-radio item-content">
                                            <input type="radio" name="updateFrequency" value="900000" />
                                            <i class="icon icon-radio"></i>
                                            <div class="item-inner">
                                                <div class="item-title">15m</div>
                                            </div>
                                        </label>
                                    </li>
                                    <li>
                                        <label class="item-radio item-content">
                                            <input type="radio" name="updateFrequency" value="1800000" checked />
                                            <i class="icon icon-radio"></i>
                                            <div class="item-inner">
                                                <div class="item-title">30m</div>
                                            </div>
                                        </label>
                                    </li>
                                    <li>
                                        <label class="item-radio item-content">
                                            <input type="radio" name="updateFrequency" value="3600000" />
                                            <i class="icon icon-radio"></i>
                                            <div class="item-inner">
                                                <div class="item-title">60m</div>
                                            </div>
                                        </label>
                                    </li>
                                </ul>
                            </div>
                        </form>
                        <div id="flightInfo" class="mt-3"></div>
                    </div>
                </div>
                <div id="flightMap" class="mt-3"></div>
            </div>

            <div class="grid-item">
                <!-- Cargo Waybill Section -->
                <div class="card">
                    <div id="cargoHeader" class="card-header bg-success text-white">
                        Cargo Waybill <span id="cargoStatus" class="status"></span>
                    </div>
                    <div class="card-body">
                        <!-- ... (keep existing cargo tracking content) ... -->
                        <form id="waybillForm">
                            <div class="list no-hairlines-md">
                                <ul>
                                    <li class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">Waybill Number</div>
                                            <div class="item-input-wrap">
                                                <input type="text" id="waybillNumber" placeholder="Enter Waybill Number" value="526 14559565">
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div class="block">
                                <button type="submit" class="button button-fill">Track Cargo</button>
                            </div>
                        </form>
                        <div id="waybillInfo" class="mt-3"></div>
                        <div id="shipmentTimeline" class="mt-3"></div>
                    </div>
                </div>

                <!-- Weather & Traffic Section -->
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        Weather & Traffic
                    </div>
                    <div class="card-body">
                        <div id="weatherInfo"></div>
                        <div id="trafficInfo" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Section -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                Navigation
            </div>
            <div class="card-body">
                <form id="navigationForm">
                    <div class="form-row">
                        <div class="col">
                            <input type="text" class="form-control" id="startLocation" placeholder="Start Location" required>
                        </div>
                        <div class="col">
                            <input type="text" class="form-control" id="waypoint" placeholder="Waypoint (optional)">
                        </div>
                        <div class="col">
                            <input type="text" class="form-control" id="endLocation" placeholder="End Location" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-info mt-2">Get Directions</button>
                </form>
                <div id="map" class="mt-3"></div>
                <div id="navigationInfo" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/framework7/5.7.14/js/framework7.bundle.min.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <script>
        $(document).ready(function(){
            // Update current time
            function updateCurrentTime() {
                $('#currentTime').text('Current Time: ' + new Date().toLocaleString());
            }
            setInterval(updateCurrentTime, 1000);

            // Flight tracking
            $('#trackFlightBtn').on('click', function() {
                var airlineCode = $('#airlineCode').val();
                var flightNumber = $('#flightNumber').val();
                var updateFrequency = $('input[name="updateFrequency"]:checked').val();

                // Implement flight tracking logic here
                // This is a placeholder for the actual API call
                app.dialog.alert('Tracking flight ' + airlineCode + flightNumber);

                $('#stopUpdatesBtn').show();
            });

            $('#stopUpdatesBtn').on('click', function() {
                // Implement stop updates logic here
                app.dialog.alert('Stopped flight updates');
                $(this).hide();
            });

            // Update flight tracking
            function updateFlightInfo(data) {
                const statusClass = data.status === 'On Time' ? 'status-ontime' : 'status-delayed';
                $('#flightHeader').removeClass('status-ontime status-delayed').addClass(statusClass);
                
                const infoHtml = `
                    <h5>Flight ${data.airlineCode}${data.flightNumber}</h5>
                    <p><strong>Status:</strong> ${data.status}</p>
                    <p><strong>Altitude:</strong> ${data.altitude} meters</p>
                    <p><strong>Speed:</strong> ${data.velocity} m/s</p>
                    <p><strong>Heading:</strong> ${data.heading}°</p>
                    <p><strong>Departure:</strong> ${data.departureTime}</p>
                    <p><strong>Arrival:</strong> ${data.arrivalTime}</p>
                `;
                $('#flightInfo').html(infoHtml);

                // Update flight position on map with direction arrow
                if (flightMarker) {
                    flightMarker.setLngLat([data.longitude, data.latitude]);
                } else {
                    flightMarker = new mapboxgl.Marker({
                        element: createArrowElement(data.heading),
                        rotationAlignment: 'map',
                        pitchAlignment: 'map'
                    })
                    .setLngLat([data.longitude, data.latitude])
                    .addTo(flightMap);
                }
                flightMap.flyTo({center: [data.longitude, data.latitude], zoom: 5});

                // Draw flight path (simplified example)
                if (data.path) {
                    flightMap.addLayer({
                        id: 'flight-path',
                        type: 'line',
                        source: {
                            type: 'geojson',
                            data: {
                                type: 'Feature',
                                properties: {},
                                geometry: {
                                    type: 'LineString',
                                    coordinates: data.path
                                }
                            }
                        },
                        layout: {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        paint: {
                            'line-color': '#888',
                            'line-width': 8
                        }
                    });
                }
            }

            function createArrowElement(rotation) {
                const el = document.createElement('div');
                el.className = 'marker-arrow';
                el.style.width = '20px';
                el.style.height = '20px';
                el.style.backgroundImage = 'url(path/to/arrow-icon.png)';
                el.style.backgroundSize = 'cover';
                el.style.transform = `rotate(${rotation}deg)`;
                return el;
            }

            // Cargo tracking
            $('#waybillForm').on('submit', function(e){
                e.preventDefault();
                const waybillNumber = $('#waybillNumber').val();

                $.ajax({
                    url: '/trackCargo',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ waybillNumber: waybillNumber }),
                    success: function(response) {
                        if (response.meta.code === 200 && response.data.success) {
                            const cargoData = response.data.success[0];
                            const statusClass = cargoData.awb_status === 'Delivered' ? 'status-ontime' : 'status-delayed';
                            $('#cargoHeader').removeClass('status-ontime status-delayed').addClass(statusClass);
                            
                            const infoHtml = `
                                <h5>Tracking Detail: ${cargoData.awb_number}</h5>
                                <p><strong>Status:</strong> ${cargoData.awb_status}</p>
                                <p><strong>Origin:</strong> ${cargoData.origin}</p>
                                <p><strong>Destination:</strong> ${cargoData.destination}</p>
                                <p><strong>Last Event:</strong> ${cargoData.last_event}</p>
                            `;
                            $('#waybillInfo').html(infoHtml);

                            let timelineHtml = '<h5>Shipment Timeline</h5><ul class="list-group">';
                            cargoData.track_info.forEach(event => {
                                timelineHtml += `
                                    <li class="list-group-item">
                                        <strong>${event.actual_date}</strong><br>
                                        ${event.event}: ${event.station}
                                    </li>
                                `;
                            });
                            timelineHtml += '</ul>';
                            $('#shipmentTimeline').html(timelineHtml);
                        } else {
                            $('#waybillInfo').html('<p class="text-danger">Error tracking cargo: ' + (response.meta.message || 'Unknown error') + '</p>');
                        }
                    },
                    error: function() {
                        $('#waybillInfo').html('<p class="text-danger">Error tracking cargo</p>');
                    }
                });
            });

            // Navigation
            $('#navigationForm').on('submit', function(e) {
                e.preventDefault();
                const start = $('#startLocation').val();
                const waypoint = $('#waypoint').val();
                const end = $('#endLocation').val();

                // Use Mapbox Directions API to get route
                // This is a simplified example and would need to be implemented with proper API calls
                const directionsRequest = `https://api.mapbox.com/directions/v5/mapbox/driving/${start};${waypoint};${end}?access_token=${mapboxgl.accessToken}`;

                $.ajax({
                    url: directionsRequest,
                    method: 'GET',
                    success: function(data) {
                        // Process and display route on map
                        // Update #navigationInfo with turn-by-turn directions
                    },
                    error: function() {
                        $('#navigationInfo').html('<p class="text-danger">Error fetching directions</p>');
                    }
                });
            });

            // ... (keep existing weather and traffic code) ...
        });
    </script>
</body>
</html>
